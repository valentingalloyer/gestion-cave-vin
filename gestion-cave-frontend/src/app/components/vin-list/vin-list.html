<div class="container">
  <h1>Ma Cave √† Vin üç∑</h1>

  <div class="search-section">
    <div class="search-container">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
           stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        type="text"
        class="search-input"
        placeholder="Rechercher un mill√©sime, un nom..."
        (input)="onSearch($event)"
      >
    </div>
    <div class="filter-container">
      <select (change)="onRegionChange($event)" class="region-select">
        <option value="">Toutes les r√©gions</option>

        @for (groupe of REGIONS_GROUPEES; track groupe.label) {
          <optgroup [label]="groupe.label">
            @for (region of groupe.regions; track region) {
              <option [value]="region">{{ region }}</option>
            }
          </optgroup>
        }
      </select>
    </div>
  </div>

  <div class="stats-container">
    <div class="stat-item">
      <span class="stat-label">Ma collection : </span>
      <div class="stat-bubble">
        <strong>{{ nombreTotalReferences() }}</strong><span class="label"> r√©f√©rences</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-bubble">
        <strong>{{ nombreTotalBouteilles() }}</strong> bouteilles dans la cave
      </div>
    </div>

    @if (searchQuery() !== '' || selectedAppellation() !== '') {
      <div class="stat-divider"></div>
      <div class="stat-item filtered">
        <span class="stat-label">R√©sultat : </span>
        <span class="stat-value">
        <strong>{{ filteredAndSortedVins().length }}</strong>
          {{ filteredAndSortedVins().length < 2 ? 'bouteille trouv√©e' : 'bouteilles trouv√©es' }}
      </span>
      </div>
    }
  </div>

  <div class="cave-container">
    @for (group of groupedVins(); track group.cle; let i = $index) {

      @if (i === 0 || group.couleur !== groupedVins()[i-1].couleur) {
        <div class="color-section-header" [class]="group.couleur.toLowerCase().replace('√©', 'e')">
          {{ group.couleur }}
        </div>
      }

      <div class="vin-group-card" [class]="group.couleur?.toLowerCase()">
        <div class="color-bar"></div>

        <div class="group-header" (click)="toggleGroup(group.cle)">
          <div class="info-section">
            <span class="expand-icon" [class.rotated]="openedGroups().has(group.cle)">‚ñ∂</span>
            <div class="titles">
              <span class="vin-nom">{{ group.nom }}</span>
              <div class="sub-titles">
                <span class="vin-domaine">{{ group.domaine }}</span>
                @if (group.appellation) {
                  <span class="vin-appellation">‚Ä¢ {{ group.appellation }}</span>
                }
              </div>
              <button class="btn-quick-add"
                      (click)="onAjouterMillesime(group); $event.stopPropagation()"
                      title="Ajouter un autre mill√©sime">
                Ajouter un mill√©sime
              </button>
            </div>
          </div>

          <div class="color-section">
            <span class="badge-couleur" [class]="group.couleur?.toLowerCase()?.replace('√©', 'e')">
              {{ group.couleur }}
            </span>
          </div>

          <div class="stock-section">
            <span class="badge-total">{{ group.totalQuantite }}</span>
          </div>
        </div>

        @if (openedGroups().has(group.cle)) {
          <div class="vintages-list" [class.show]="openedGroups().has(group.cle)">
            @for (v of group.vintages; track v.id) {
              <div class="vintage-row">
                <span class="year">Ann√©e {{ v.millesime }}</span>

                <span class="location">üìç {{ v.emplacement || 'Non class√©' }}</span>

                <div class="actions-container">
                  <div class="qty-actions">
                    <button (click)="changerQuantite(v, -1); $event.stopPropagation()">-</button>
                    <span class="qty">{{ v.quantite }}</span>
                    <button (click)="changerQuantite(v, 1); $event.stopPropagation()">+</button>
                  </div>

                  <button class="btn-delete" (click)="supprimerVin(v.id!, v.nom, v.millesime); $event.stopPropagation()"
                          title="Supprimer d√©finitivement">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    } @empty {
      <div class="empty-msg">Aucun vin ne correspond √† votre recherche.</div>
    }
  </div>
</div>


@if (toastService.message()) {
  <div class="toast-notification">
    {{ toastService.message() }}
  </div>
}
