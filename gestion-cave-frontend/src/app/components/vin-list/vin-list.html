@if (isLoading()) {
  <div class="loading-overlay">
    <div class="wine-loader"></div>
    @if (!isTakingLonger()) {
      <p>Chargement de la cave...</p>
    } @else {
      <div class="wake-up-msg">
        <p>üç∑ <strong>Le serveur se r√©veille...</strong></p>
        <p>R√©veil en cours (jusqu'√† 1min30 apr√®s inactivit√©).</p>
        <progress></progress>
      </div>
    }
  </div>
} @else {
  <div class="container">
    <h1>La cave √† Jack üç∑</h1>

    <div class="search-section">
      <div class="search-container full-width">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" class="search-input" placeholder="Rechercher un vin, un mill√©sime..."
               (input)="onSearch($event)">
      </div>
    </div>

    <div class="stats-bar">
      <span><strong>{{ nombreTotalReferences() }}</strong> r√©f√©rences</span>
      <div class="divider"></div>
      <span><strong>{{ nombreTotalBouteilles() }}</strong> bouteilles</span>
    </div>

    <div class="cave-grid">
      @for (region of groupedVins() | keyvalue; track region.key) {
        <section class="region-block">
          <header class="region-header" (click)="toggleRegion(region.key)" style="cursor: pointer;">
            <h2>
              <span class="chevron" [class.rotated]="isRegionCollapsed(region.key)">‚ñ∂</span>
              üìç {{ region.key }}
            </h2>
            <span class="region-total">{{ getCountForRegion(region.value) }} bouteilles</span>
          </header>

          <!-- Body r√©gion -->
          @if (!isRegionCollapsed(region.key)) {
            <div class="region-body">
              @for (nameGroup of region.value | keyvalue; track nameGroup.key) {
                <div class="wine-family">
                  <div class="wine-family-header">
                    <h3>{{ nameGroup.key }}</h3>
                  </div>

                  @for (domainGroup of nameGroup.value | keyvalue; track domainGroup.key) {
                    <div class="domain-group">
                      <div class="domain-header">
                        <h4 class="domain-title">üè∞ {{ domainGroup.key }}</h4>
                        <button
                          class="btn-mini-add"
                          (click)="onAjouterMillesime(domainGroup.value[0])"
                          title="Ajouter une autre ann√©e pour ce domaine">
                          <span class="plus-icon">+</span> Mill√©sime
                        </button>
                      </div>
                      <div class="bottle-list">
                        @for (v of domainGroup.value; track v.id) {
                          <div class="bottle-item" [class]="v.couleur.toLowerCase()">
                            <span class="col-year">{{ v.millesime }}</span>
                            <div class="col-apogee" [title]="'√Ä boire entre ' + v.apogeeDebut + ' et ' + v.apogeeFin">
                              @if (v.apogeeDebut && v.apogeeFin) {
                                <span class="icon">‚åõ</span>
                                {{ v.apogeeDebut }} - {{ v.apogeeFin }}
                              }
                            </div>
                            <div class="col-note">
                              @for (star of [1,2,3,4,5]; track star) {
                                <span class="star" [class.filled]="v.note && v.note >= star">‚òÖ</span>
                              }
                            </div>
                            <span class="col-comment" [title]="v.notePersonnelle">
                              {{ v.notePersonnelle }}
                            </span>
                            <span class="col-loc">{{ v.emplacement }}</span>

                            <div class="col-actions">
                              <div class="qty-control">
                                <button (click)="changerQuantite(v, -1)">-</button>
                                <span class="qty">{{ v.quantite }}</span>
                                <button (click)="changerQuantite(v, 1)">+</button>
                              </div>
                              <button class="btn-trash" (click)="supprimerVin(v.id!, v.nom, v.millesime)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                     stroke-width="2">
                                  <path
                                    d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                              </button>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </section>
      }
    </div>
    @if (filteredAndSortedVins().length === 0 && !isLoading()) {
      <div class="no-result">
        <p>üïµÔ∏è‚Äç‚ôÇÔ∏è Aucune bouteille ne correspond √† "<strong>{{ searchQuery() }}</strong>"</p>
        <button (click)="resetSearch()" class="btn-link">Voir toute la cave</button>
      </div>
    }
  </div>
}
