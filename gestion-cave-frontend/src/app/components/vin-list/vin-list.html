<div class="container">
  <h1>Ma Cave √† Vin üç∑</h1>

  <div class="search-section">
    <div class="search-container">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
           stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        type="text"
        class="search-input"
        placeholder="Rechercher un mill√©sime, un nom..."
        (input)="onSearch($event)"
      >
    </div>
  </div>

  <div class="stats-container">
    <div class="stat-item">
      <span class="stat-label">Ma collection : </span>
      <span class="stat-value">
      <strong>{{ vins().length }}</strong>
        {{ vins().length < 2 ? 'bouteille' : 'bouteilles' }} dans la cave
    </span>
    </div>

    @if (searchQuery() !== '') {
      <div class="stat-divider"></div>
      <div class="stat-item filtered">
        <span class="stat-label">R√©sultat : </span>
        <span class="stat-value">
        <strong>{{ filteredAndSortedVins().length }}</strong>
          {{ filteredAndSortedVins().length < 2 ? 'bouteille trouv√©e' : 'bouteilles trouv√©es' }}
      </span>
      </div>
    }
  </div>

  <div class="table-header">
    <div (click)="setSort('nom')" class="sortable">
      Vin / Domaine {{ sortKey() === 'nom' ? (sortDirection() === 'asc' ? '‚Üë' : '‚Üì') : '' }}
    </div>
    <div (click)="setSort('couleur')" class="sortable">
      Couleur {{ sortKey() === 'couleur' ? (sortDirection() === 'asc' ? '‚Üë' : '‚Üì') : '' }}
    </div>
    <div (click)="setSort('quantite')" class="sortable text-right">
      Total Stock {{ sortKey() === 'quantite' ? (sortDirection() === 'asc' ? '‚Üë' : '‚Üì') : '' }}
    </div>
  </div>

  <div class="cave-container">
    @for (group of groupedVins(); track group.cle; let i = $index) {

      @if (i === 0 || group.couleur !== groupedVins()[i-1].couleur) {
        <div class="color-section-header" [class]="group.couleur.toLowerCase().replace('√©', 'e')">
          {{ group.couleur }}
        </div>
      }

      <div class="vin-group-card" [class]="group.couleur?.toLowerCase()">
        <div class="color-bar"></div>

        <div class="group-header" (click)="toggleGroup(group.cle)">
          <div class="info-section">
            <span class="expand-icon" [class.rotated]="openedGroups().has(group.cle)">‚ñ∂</span>
            <div class="titles">
              <span class="vin-nom">{{ group.nom }}</span>
              <div class="sub-titles">
                <span class="vin-domaine">{{ group.domaine }}</span>
                @if (group.appellation) {
                  <span class="vin-appellation">‚Ä¢ {{ group.appellation }}</span>
                }
              </div>
            </div>
          </div>

          <div class="color-section">
            <span class="badge-couleur" [class]="group.couleur?.toLowerCase()?.replace('√©', 'e')">
              {{ group.couleur }}
            </span>
          </div>

          <div class="stock-section">
            <span class="badge-total">{{ group.totalQuantite }}</span>
          </div>
        </div>

        @if (openedGroups().has(group.cle)) {
          <div class="vintages-list" [class.show]="openedGroups().has(group.cle)">
            @for (v of group.vintages; track v.id) {
              <div class="vintage-row">
                <span class="year">Ann√©e {{ v.millesime }}</span>

                <span class="location">üìç {{ v.emplacement || 'Non class√©' }}</span>

                <div class="qty-actions">
                  <button (click)="changerQuantite(v, -1); $event.stopPropagation()">-</button>
                  <span class="qty">{{ v.quantite }}</span>
                  <button (click)="changerQuantite(v, 1); $event.stopPropagation()">+</button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    } @empty {
      <div class="empty-msg">Aucun vin ne correspond √† votre recherche.</div>
    }
  </div>
</div>
